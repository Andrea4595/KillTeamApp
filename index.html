<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kill Team Roster Builder</title>
    <style>
        :root {
            --primary-color: #598c28; /* Default Ork Green */
            --bg-dark: #2c3e50;
            --card-bg: #34495e;
            --text-light: #ecf0f1;
            --danger: #c0392b; 
            --warning: #f39c12;
            --btn-hover: rgba(255,255,255,0.1);
            
            /* HP Colors */
            --hp-active: #e74c3c;      
            --hp-damaged: #78281f;     
            --hp-recovered: #2ecc71;   
            --hp-inactive: #17202a;    
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-light);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 600px;
            padding: 20px;
            min-height: 100vh;
            background-color: rgba(0,0,0,0.3);
            position: relative;
            padding-bottom: 80px;
        }

        h1, h2, h3 { 
            color: var(--primary-color); 
            text-transform: uppercase; 
            letter-spacing: 1px;
            margin-top: 0;
        }

        /* ìœ í‹¸ë¦¬í‹° */
        .screen { display: none; animation: fadeIn 0.3s; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* ë²„íŠ¼ */
        .btn {
            padding: 12px 20px; border: none; border-radius: 4px;
            font-weight: bold; font-size: 1rem; cursor: pointer;
            transition: all 0.2s; width: 100%; text-align: center;
        }
        .btn-primary { background-color: var(--primary-color); color: white; margin-top: 10px; }
        .btn-primary:hover { filter: brightness(1.1); }
        .btn-danger { background-color: var(--danger); color: white; width: auto; }
        .btn-secondary { background-color: #7f8c8d; color: white; width: auto; }
        .btn-info { background-color: #3498db; color: white; }
        .btn-small { padding: 5px 10px; font-size: 0.8rem; margin-top: 5px; width: auto; display: inline-block;}
        .btn-outline { background: transparent; border: 1px solid var(--primary-color); color: var(--primary-color); }
        .btn-equip { background-color: #e67e22; color: white; font-size: 0.8rem; padding: 4px 8px; border-radius: 4px; border:none; cursor: pointer;}

        /* ì¸í’‹ & ì…€ë ‰íŠ¸ */
        .roster-input, .roster-select {
            width: 100%; padding: 12px; margin-bottom: 15px;
            font-size: 1.1rem; background: var(--card-bg);
            border: 2px solid var(--primary-color); color: white; border-radius: 4px;
        }
        .roster-select { cursor: pointer; }

        /* ë¡œìŠ¤í„° ê´€ë¦¬ ì„¹ì…˜ */
        .roster-manager {
            background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px;
            margin-bottom: 20px; border: 1px solid #555;
        }

        /* ìƒë‹¨ ìì›ë°” */
        .top-bar {
            position: sticky; top: 0; z-index: 10;
            background: var(--bg-dark); padding-bottom: 10px;
            border-bottom: 1px solid #444; margin-bottom: 10px;
        }
        .tp-tracker {
            background: rgba(0,0,0,0.4); padding: 5px 10px; border-radius: 8px;
            margin-bottom: 10px; display: flex; justify-content: space-between;
            align-items: center; border: 1px solid var(--primary-color);
        }
        .resource-grid {
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px;
        }
        .resource-box {
            background: var(--card-bg); padding: 5px; border-radius: 5px;
            display: flex; flex-direction: column; align-items: center; border: 1px solid #555;
        }
        .resource-label { font-size: 0.65rem; color: #aaa; text-transform: uppercase; margin-bottom: 2px; }
        .resource-val { font-size: 1.4rem; font-weight: bold; color: white; }
        .res-btn-group { display: flex; gap: 5px; }
        .res-btn { 
            width: 24px; height: 24px; padding: 0; font-size: 1rem; line-height: 1;
            background: #444; color: white; border: none; border-radius: 3px; cursor: pointer;
        }

        /* íƒ­ ì‹œìŠ¤í…œ */
        .tab-nav {
            display: flex; background: #222; border-radius: 8px 8px 0 0;
            overflow: hidden; margin-top: 10px;
        }
        .tab-btn {
            flex: 1; padding: 12px; background: #222; color: #aaa; border: none;
            font-weight: bold; cursor: pointer; border-bottom: 3px solid transparent;
        }
        .tab-btn.active { background: var(--card-bg); color: white; border-bottom: 3px solid var(--primary-color); }
        .tab-content { display: none; padding: 10px 0; }
        .tab-content.active { display: block; }

        /* ì¹´ë“œ & ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .op-card, .ploy-card {
            background: var(--card-bg); border-radius: 8px; padding: 15px;
            margin-bottom: 15px; border: 1px solid #555; position: relative;
        }
        .op-card.incapacitated { opacity: 0.7; filter: grayscale(80%); border: 2px solid #17202a; }
        .op-card.injured { border: 2px solid var(--warning); }
        
        .ploy-card { border-left: 3px solid #777; padding: 10px; margin-bottom:10px;}
        .ploy-card.strat { border-left-color: #3498db; }
        .ploy-card.fire { border-left-color: #e74c3c; }
        
        .op-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .op-role { font-size: 0.8rem; background: #222; padding: 2px 6px; border-radius: 3px; color: #aaa; }
        
        /* ìŠ¤íƒ¯ í…Œì´ë¸” */
        .stat-table { width: 100%; text-align: center; border-collapse: collapse; margin-bottom: 10px; }
        .stat-table th { font-size: 0.7rem; color: #aaa; padding-bottom: 5px; }
        .stat-table td { font-size: 1.1rem; font-weight: bold; border: 1px solid #444; padding: 5px; }
        .stat-modified { color: var(--warning); text-decoration: underline; }

        /* ë¬´ê¸° ëª©ë¡ */
        .weapon-row {
            display: flex; flex-direction: column; font-size: 0.85rem;
            border-bottom: 1px solid #444; padding: 8px 0; transition: all 0.2s;
        }
        .weapon-main { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .weapon-name { font-weight: bold; color: #ddd; }
        .weapon-stats { font-family: monospace; color: #bbb; }
        .weapon-range-badge { font-size: 0.7rem; padding: 1px 4px; border-radius: 3px; margin-right: 5px; }
        .range-ranged { background: #2980b9; color: white; }
        .range-melee { background: #c0392b; color: white; }
        .weapon-rules { font-size: 0.75rem; color: #aaa; margin-top: 2px; padding-left: 20px; font-style: italic; }
        .rule-tag { color: #f1c40f; margin-right: 5px; }
        
        .weapon-row.interactive { cursor: pointer; }
        .weapon-row.interactive:hover { background-color: rgba(255, 255, 255, 0.1); }
        .weapon-row.inactive { opacity: 0.3; text-decoration: line-through; }

        /* ì¥ë¹„ í‘œì‹œ (ì¹´ë“œ ë‚´) */
        .card-equip-section {
            margin-top: 10px; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 5px;
            font-size: 0.9rem;
        }
        .card-equip-item {
            display: flex; justify-content: space-between; align-items: flex-start;
            margin-bottom: 6px; padding-bottom: 6px; border-bottom: 1px solid #444;
            transition: all 0.2s;
        }
        .card-equip-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        
        /* ì‚¬ìš©ëœ ì¥ë¹„ (Dimmed) */
        .card-equip-item.used { opacity: 0.4; filter: grayscale(100%); text-decoration: line-through; }
        .card-equip-item.interactive { cursor: pointer; }
        .card-equip-item.interactive:hover { background: rgba(255,255,255,0.05); }

        .equip-name { color: #e67e22; font-weight: bold; display: block;}
        .equip-desc-small { font-size: 0.75rem; color: #aaa; margin-top: 2px; line-height: 1.2; }

        /* ì²´ë ¥ íŠ¸ë˜ì»¤ */
        .wounds-container { margin-top: 15px; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; }
        .hp-grid { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 5px; }
        .hp-btn {
            width: 28px; height: 28px; border: 1px solid #444; border-radius: 4px;
            cursor: pointer; display: flex; justify-content: center; align-items: center;
            font-size: 0.7rem; font-weight: bold; color: rgba(255,255,255,0.7);
        }
        .hp-btn.active { background-color: var(--hp-active); color: white; }
        .hp-btn.damaged { background-color: var(--hp-damaged); opacity: 0.8; }
        .hp-btn.recovered { background-color: var(--hp-recovered); color: #111; }
        .hp-btn.inactive { background-color: var(--hp-inactive); opacity: 0.5; }

        /* ëª¨ë‹¬ */
        #modal-overlay, #equip-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: none;
            justify-content: center; align-items: center; z-index: 100;
        }
        .modal-content {
            background: var(--bg-dark); padding: 20px; border-radius: 8px;
            width: 95%; max-width: 600px; max-height: 90vh; overflow-y: auto;
            border: 2px solid var(--primary-color);
        }
        .modal-close { position: sticky; bottom: 0; left: 0; width: 100%; background: var(--bg-dark); padding-top: 10px; }

        /* ì•Œë¦¼ ë©”ì‹œì§€ */
        #toast-msg {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: #333; color: white; padding: 10px 20px; border-radius: 30px;
            font-size: 0.9rem; z-index: 200; opacity: 0; pointer-events: none;
            transition: opacity 0.3s; border: 1px solid var(--primary-color);
        }
        #toast-msg.show { opacity: 1; }

        .equip-btn-list button {
            width: 100%; text-align: left; padding: 10px; margin-bottom: 5px;
            background: var(--card-bg); border: 1px solid #555; color: white;
            cursor: pointer;
        }
        .equip-btn-list button:hover { background: #444; }
        .equip-btn-list button:disabled { opacity: 0.5; cursor: not-allowed; text-decoration: line-through; }

    </style>
</head>
<body>

<div class="container">
    <!-- 1. ë¡œìŠ¤í„° í™”ë©´ (ë¹Œë”) -->
    <div id="screen-roster" class="screen active">
        <h1>ğŸ› ï¸ ë¡œìŠ¤í„° ë¹Œë”</h1>
        
        <div class="roster-manager">
            <label style="font-size: 0.9rem; color: #aaa; display:block; margin-bottom:5px;">ğŸ“‚ ë¡œìŠ¤í„° ì„ íƒ</label>
            <div style="display: flex; gap: 10px;">
                <select id="roster-select" class="roster-select" onchange="switchRoster()" style="margin-bottom: 0;">
                    <option value="new">+ ìƒˆ ë¡œìŠ¤í„° ë§Œë“¤ê¸°</option>
                </select>
                <button class="btn btn-danger" onclick="deleteCurrentRoster()" style="width: auto; padding: 0 15px;">ì‚­ì œ</button>
            </div>
        </div>

        <div style="margin-bottom: 20px;">
            <label style="font-size: 0.9rem; color: #aaa;">ë¡œìŠ¤í„° ì´ë¦„</label>
            <input type="text" id="roster-name" class="roster-input" placeholder="ì˜ˆ: ë‚˜ì˜ ìµœê°• í‚¬íŒ€" value="ìƒˆ ë¡œìŠ¤í„°">
        </div>

        <div style="margin-bottom: 20px;">
            <label style="font-size: 0.9rem; color: #aaa;">í‚¬ íŒ€ ì„ íƒ</label>
            <select id="team-select" class="roster-select" onchange="changeTeam()">
                <!-- JS Option -->
            </select>
        </div>

        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <button class="btn btn-info" onclick="openInfoModal()" style="width: auto;">ğŸ“– íŒ©ì…˜ ì •ë³´ ë³´ê¸° (ë£°/ê³„ëµ)</button>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; margin-top: 20px;">
            <h3>íŒ€ êµ¬ì„± (<span id="roster-count">0</span>ëª…)</h3>
            <div style="font-size:0.9rem; color:#aaa;">ì¥ë¹„: <span id="equip-count" style="color:var(--primary-color); font-weight:bold;">0</span> / 4</div>
        </div>
        <button class="btn btn-secondary" onclick="openAddModal()" style="margin-bottom: 10px;">+ ì˜¤í¼ë ˆì´í‹°ë¸Œ ì¶”ê°€</button>

        <div id="my-roster-list"></div>

        <div style="margin-top: 30px;">
            <button class="btn btn-primary" onclick="startGame()">ğŸš€ ê²Œì„ ì‹œì‘</button>
        </div>
    </div>

    <!-- 2. ê²Œì„ í™”ë©´ (í”Œë ˆì´ ëª¨ë“œ) -->
    <div id="screen-game" class="screen">
        <div class="top-bar">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                <button class="btn btn-secondary" onclick="showScreen('roster')" style="width: auto; padding: 5px 10px;">â† ë‚˜ê°€ê¸°</button>
                <h3 id="game-title" style="margin: 0; font-size: 1.1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"></h3>
            </div>

            <!-- TP Tracker -->
            <div class="tp-tracker">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 1.2rem; font-weight: bold;">Turn (TP)</span>
                    <div class="resource-control">
                        <button class="res-btn" onclick="updateTP(-1)">-</button>
                        <span id="tp-val" class="resource-val">1</span>
                        <button class="res-btn" onclick="updateTP(1)">+</button>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="endTurn()" style="width: auto; margin-top:0; padding: 5px 12px; font-size: 0.9rem;">ğŸ í„´ ì¢…ë£Œ</button>
            </div>

            <!-- Resource Grid -->
            <div class="resource-grid" id="resource-grid">
                <div class="resource-box">
                    <span class="resource-label">VP (ìŠ¹ì )</span>
                    <span id="vp-val" class="resource-val">0</span>
                    <div class="res-btn-group">
                        <button class="res-btn" onclick="updateResource('vp', -1)">-</button>
                        <button class="res-btn" onclick="updateResource('vp', 1)">+</button>
                    </div>
                </div>
                <div class="resource-box">
                    <span class="resource-label">CP (ì»¤ë§¨ë“œ)</span>
                    <span id="cp-val" class="resource-val">2</span>
                    <div class="res-btn-group">
                        <button class="res-btn" onclick="updateResource('cp', -1)">-</button>
                        <button class="res-btn" onclick="updateResource('cp', 1)">+</button>
                    </div>
                </div>
                <!-- Faction Resource Box -->
                <div class="resource-box" id="faction-res-box" style="display: none; border-color: var(--primary-color);">
                    <span class="resource-label" id="fp-name">FP</span>
                    <span id="fp-val" class="resource-val" style="color: var(--primary-color);">0</span>
                    <div class="res-btn-group">
                        <button class="res-btn" onclick="updateResource('fp', -1)">-</button>
                        <button class="res-btn" onclick="updateResource('fp', 1)">+</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Nav -->
        <div class="tab-nav">
            <button class="tab-btn active" onclick="switchTab('ops', event)">ì˜¤í¼ë ˆì´í‹°ë¸Œ</button>
            <button class="tab-btn" onclick="switchTab('ploys', event)">ê·œì¹™ & ê³„ëµ</button>
            <button class="tab-btn" onclick="switchTab('equip', event)">ì¥ë¹„ ë„ê°</button>
        </div>

        <!-- Tab Contents -->
        <div id="tab-ops" class="tab-content active">
            <div id="game-op-list"></div>
        </div>

        <div id="tab-ploys" class="tab-content">
            <h3 style="margin-top:0;">ğŸ“œ íŒ©ì…˜ ê·œì¹™</h3>
            <div id="game-faction-rules"></div>
            <h3>âš¡ ì „ëµ ê³„ëµ</h3>
            <div id="game-strat-ploys"></div>
            <h3>ğŸ”¥ êµì „ ê³„ëµ</h3>
            <div id="game-fire-ploys"></div>
        </div>

        <div id="tab-equip" class="tab-content">
            <h3 style="margin-top:0;">ğŸ’ ì¥ë¹„ ë„ê° (Reference)</h3>
            <div id="game-equipment-list"></div>
        </div>
    </div>
</div>

<!-- ì˜¤í¼ë ˆì´í‹°ë¸Œ ì¶”ê°€ ëª¨ë‹¬ -->
<div id="modal-overlay">
    <div class="modal-content">
        <h3 style="margin-bottom: 15px;">ì˜¤í¼ë ˆì´í‹°ë¸Œ ì„ íƒ</h3>
        <div id="modal-op-list"></div>
        <div class="modal-close">
            <button class="btn btn-danger" onclick="closeAddModal()" style="width: 100%;">ë‹«ê¸°</button>
        </div>
    </div>
</div>

<!-- ì¥ë¹„ ì¶”ê°€ ëª¨ë‹¬ -->
<div id="equip-modal-overlay">
    <div class="modal-content">
        <h3 style="margin-bottom: 15px;">ì¥ë¹„ ì¶”ê°€</h3>
        <div id="equip-modal-list" class="equip-btn-list"></div>
        <div class="modal-close">
            <button class="btn btn-danger" onclick="closeEquipModal()" style="width: 100%;">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<!-- ì •ë³´ ë³´ê¸° ëª¨ë‹¬ -->
<div id="info-modal-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 100;">
    <div class="modal-content">
        <h2 style="margin-top:0;">ğŸ“– íŒ©ì…˜ ì •ë³´</h2>
        
        <h3>ğŸ“œ íŒ©ì…˜ ê·œì¹™</h3>
        <div id="info-faction-rules"></div>

        <h3>âš¡ ì „ëµ ê³„ëµ</h3>
        <div id="info-strat-ploys"></div>

        <h3>ğŸ”¥ êµì „ ê³„ëµ</h3>
        <div id="info-fire-ploys"></div>

        <div class="modal-close">
            <button class="btn btn-danger" onclick="closeInfoModal()" style="width: 100%;">ë‹«ê¸°</button>
        </div>
    </div>
</div>

<div id="toast-msg"></div>

<script>
    /** * ë°ì´í„° ì¹´íƒˆë¡œê·¸ */
    const catalog = {
        "ork_wrecka_krew": {
            name: "ë ‰ì¹´ í¬ë£¨ (Orks)",
            color: "#598c28",
            rulesText: "â€¢ ë¦¬ë” 1ëª… (í•„ìˆ˜)<br>â€¢ ë°¤ ìŠ¤í€´ê·¸ 2ëª… (í•„ìˆ˜)<br>â€¢ ë‚˜ë¨¸ì§€ 5ëª… ì„ íƒ (ê° ì „ë¬¸ê°€ ìµœëŒ€ 1ëª…)",
            
            resourceConfig: { name: "Wrecka Pts", start: 0, min: 0, max: 6 },

            factionRules: [
                { title: "Wrecka Rampage", desc: "ì‚¬ê²©/ê²©íˆ¬ ì‹œ 6ì´ ë‚˜ì˜¤ë©´ ë ‰ì¹´ í¬ì¸íŠ¸ +1. (ìµœëŒ€ 6ì )<br>í¬ì¸íŠ¸ë¥¼ ì†Œëª¨í•´ ì‹¤íŒ¨í•œ ì£¼ì‚¬ìœ„ë¥¼ ì¼ë°˜ ì„±ê³µìœ¼ë¡œ ë³€ê²½ ê°€ëŠ¥." },
                { title: "Tanked Up", desc: "Engage ì˜¤ë”ì¸ ì•„êµ°ì´ ì‚¬ê²©/ê²©íˆ¬ ì•¡ì…˜ ìˆ˜í–‰ ì‹œ, ë‹¤ìŒ í™œì„±í™”ê¹Œì§€ APL +1." }
            ],
            ploys: {
                strategy: [
                    { name: "Waaagh!", cost: "1CP", desc: "ì´ë²ˆ í„´ ë™ì•ˆ ì•„êµ° ê·¼ì ‘ ë¬´ê¸°ì— [Balanced] ë¶€ì—¬." },
                    { name: "Tuff Gitz", cost: "1CP", desc: "Engage ì˜¤ë”ì¸ ì•„êµ°ì´ ì‚¬ê²©ë‹¹í•  ë•Œ ë°©ì–´ ì£¼ì‚¬ìœ„ 1ê°œ ë¦¬ë¡¤." },
                    { name: "Destruction", cost: "1CP", desc: "ì´ë²ˆ í„´ ë™ì•ˆ ì•„êµ° ì‚¬ê²© ë¬´ê¸°ì— [Saturate] ë¶€ì—¬." },
                    { name: "Amped Up", cost: "1CP", desc: "Engage ì˜¤ë”ì¸ ì•„êµ°ë“¤ ê°ê° D3+1 ì²´ë ¥ íšŒë³µ." }
                ],
                firefight: [
                    { name: "Just a Scratch", cost: "1CP", desc: "ì¼ë°˜ í”¼í•´ 1ê°œë¥¼ ë¬´ì‹œ. (ë¦¬ì•¡ì…˜ìœ¼ë¡œ ì‚¬ìš©)" },
                    { name: "Demolition Job", cost: "1CP", desc: "ì‚¬ê²©/ê²©íˆ¬ í›„ ë§ˆì»¤ ë°°ì¹˜. ë§ˆì»¤ ê·¼ì²˜ ì  ê³µê²© ì‹œ í¬ì¸íŠ¸ ì†Œëª¨ ë¬´ë£Œ." },
                    { name: "Proppa Scrap", cost: "1CP", desc: "í•´ë‹¹ ì˜¤í¼ë ˆì´í‹°ë¸Œê°€ ì´ë²ˆ í™œì„±í™”ì— ê²©íˆ¬(Fight)ë¥¼ 2ë²ˆ ìˆ˜í–‰ ê°€ëŠ¥." },
                    { name: "Kaboom!", cost: "1CP", desc: "Blast ë¬´ê¸° ì‚¬ê²© ì‹œ, Blast ë²”ìœ„ +1ì¸ì¹˜ ë° ì£¼ëŒ€ìƒì—ê²Œ [Severe] ì ìš©." }
                ]
            },
            equipments: [
                // Faction Equipment (ë ‰ì¹´ í¬ë£¨: ì „íˆ¬ë‹¹ 1ê°œ ì œí•œ)
                { id: "eq_drill", name: "Drill Rokkits", cost: "EP", desc: "ë¡í‚· ëŸ°ì³ê°€ [Blast]ë¥¼ ìƒê³  [Piercing 1]ì„ ì–»ìŒ.", limit: 1 },
                { id: "eq_armor", name: "Extra Armour", cost: "EP", desc: "ì´ë™ë ¥ -1ì¸ì¹˜, ì²´ë ¥(Wounds) +1.", limit: 1 },
                { id: "eq_oil", name: "Engine Oil", cost: "EP", desc: "í•œ í„´ì— í•œ ë²ˆ, ë¶€ìƒ(Injured) í˜ë„í‹° ë¬´ì‹œ.", limit: 1 },
                { id: "eq_glyph", name: "Glyphs", cost: "EP", desc: "Waaagh! ë˜ëŠ” Destruction ì‚¬ìš© ì‹œ ë¹„ìš© í• ì¸.", limit: 1 },
                
                // Universal Equipment (ê³µìš©: ì¼ë°˜ì ìœ¼ë¡œ ì œí•œ ì—†ìŒ, ë‹¨ ìˆ˜ë¥˜íƒ„ì€ 1ì¸ë‹¹ 1ê°œ ë£° ì¡´ì¬í•  ìˆ˜ ìˆìœ¼ë‚˜ ì—¬ê¸°ì„  ì œí•œ í•´ì œ)
                { id: "eq_frag", name: "Frag Grenade", cost: "EP", desc: "Ranged 6\", Blast 2\", Dmg 4/5 (ë²”ìœ„ ê³µê²©)", limit: 99 },
                { id: "eq_krak", name: "Krak Grenade", cost: "EP", desc: "Ranged 6\", AP1, Dmg 4/5 (ê³ ê´€í†µ)", limit: 99 },
                { id: "eq_smoke", name: "Smoke Grenade", cost: "EP", desc: "ì—°ë§‰ ìƒì„± (ì‹œì•¼ ì°¨ë‹¨)", limit: 99 },
                { id: "eq_barricade", name: "Portable Barricade", cost: "EP", desc: "ì—„íë¬¼(Cover) ì œê³µ", limit: 99 },
                { id: "eq_rope", name: "Climbing Rope", cost: "EP", desc: "ë“±ë°˜ ì´ë™ ì‹œ ê±°ë¦¬ í˜ë„í‹° ë¬´ì‹œ", limit: 99 }
            ],
            operatives: [
                {
                    id: "boss_nob",
                    name: "ë ‰ì¹´ ë³´ìŠ¤ ë†‰",
                    role: "ë¦¬ë”",
                    stats: { M: "6\"", APL: 2, D: 3, S: "4+", W: 14 },
                    abilities: [{ title: "Wrecka Boss", desc: "ì‚¬ê²©/ê²©íˆ¬(ê°€ë“œ ì œì™¸) ì‹œ 1 ë ‰ì¹´ í¬ì¸íŠ¸ íšë“." }],
                    weapons: [
                        { name: "ë¡í‚· í”¼ìŠ¤í†¨", A: 6, hit: "5+", dmg: "4/5", range: "Ranged", rules: ["Rng 8\"", "Blast 1\""] },
                        { name: "ë¡í‚· í”¼ìŠ¤í†¨ ìŒìˆ˜ (ì§‘ì¤‘)", A: 6, hit: "4+", dmg: "4/5", range: "Ranged", rules: ["Rng 8\"", "Blast 1\"", "Ceaseless"] },
                        { name: "ë¡í‚· í”¼ìŠ¤í†¨ ìŒìˆ˜ (ì¼ì œ)", A: 6, hit: "5+", dmg: "4/5", range: "Ranged", rules: ["Rng 8\"", "Blast 1\"", "Salvo"] },
                        { name: "ìŠ¤ë§¤ì‹œ í•´ë¨¸", A: 4, hit: "3+", dmg: "5/6", range: "Melee", rules: ["Brutal"] },
                        { name: "ì±±íŒŒ", A: 4, hit: "3+", dmg: "4/5", range: "Melee", rules: [] }
                    ]
                },
                {
                    id: "bomb_squig",
                    name: "ë°¤ ìŠ¤í€´ê·¸",
                    role: "ì¼ë°˜ë³‘",
                    stats: { M: "6\"", APL: 2, D: 3, S: "5+", W: 5 },
                    abilities: [
                        { title: "Stoopid", desc: "Conceal ë¶ˆê°€, ì•¡ì…˜ ì œí•œë¨." },
                        { title: "Boom!", desc: "ë¬´ë ¥í™” ì‹œ 4+ ë¡¤ ì„±ê³µí•˜ë©´ ê³µì§œ ìí­ ì‚¬ê²©." },
                        { title: "Expendable", desc: "ìŠ¹ë¦¬ ì¡°ê±´ ê³„ì‚° ì œì™¸." }
                    ],
                    weapons: [
                        { name: "í­ë°œë¬¼ (ìí­)", A: 6, hit: "4+", dmg: "4/5", range: "Ranged", rules: ["Blast 1\"", "Limited 1", "Explosive"] },
                        { name: "ë¬¼ê¸°", A: 3, hit: "4+", dmg: "4/5", range: "Melee", rules: [] }
                    ]
                },
                {
                    id: "demolisha",
                    name: "ë°ëª°ë¦¬ì…”",
                    role: "ì „ë¬¸ê°€",
                    stats: { M: "6\"", APL: 2, D: 3, S: "4+", W: 12 },
                    abilities: [{ title: "Reckless", desc: "ìí•´ í”¼í•´ ê°ì†Œ (ì¼ë°˜ 4+ ì‹œ -1Dmg)." }],
                    weapons: [
                        { name: "íƒ±í¬í•´ë¨¸ (ê¸°í­)", A: 4, hit: "3+", dmg: "4/5", range: "Melee", rules: ["Lethal 5+", "Limited 1", "Detonate"] },
                        { name: "íƒ±í¬í•´ë¨¸ (íƒ€ê²©)", A: 4, hit: "3+", dmg: "4/5", range: "Melee", rules: [] }
                    ]
                },
                {
                    id: "fighter",
                    name: "íŒŒì´í„°",
                    role: "ì¼ë°˜ë³‘",
                    stats: { M: "6\"", APL: 2, D: 3, S: "4+", W: 12 },
                    abilities: [{ title: "BREAK STUFF", desc: "ì§€í˜•ì§€ë¬¼ì— Breach ë§ˆì»¤ ì„¤ì¹˜." }],
                    weapons: [
                        { name: "ìŠ¤ë§¤ì‹œ í•´ë¨¸", A: 4, hit: "3+", dmg: "5/6", range: "Melee", rules: ["Brutal"] }
                    ]
                },
                {
                    id: "krusha",
                    name: "í¬ëŸ¬ì…”",
                    role: "ì „ë¬¸ê°€",
                    stats: { M: "6\"", APL: 2, D: 3, S: "4+", W: 12 },
                    abilities: [{ title: "Armoured Up", desc: "ìƒëŒ€ëŠ” ì´ ëª¨ë¸ ê³µê²© ì‹œ 6 ë¯¸ë§Œìœ¼ë¡œ ì¹˜ëª…íƒ€ ë¶ˆê°€." }],
                    weapons: [
                        { name: "ë„ˆí´ë²„ìŠ¤íƒ€", A: 4, hit: "3+", dmg: "5/6", range: "Melee", rules: ["Brutal", "Shock", "Smash"] }
                    ]
                },
                {
                    id: "gunner",
                    name: "ê±°ë„ˆ",
                    role: "ì¼ë°˜ë³‘",
                    stats: { M: "6\"", APL: 2, D: 3, S: "4+", W: 12 },
                    abilities: [{ title: "Kompetitive", desc: "ì´ë²ˆ í„´ ì•„êµ°ì´ ìœ ì  ë˜ ì˜ë©´ 1 ë ‰ì¹´ í¬ì¸íŠ¸." }],
                    weapons: [
                        { name: "í—¤ë¹„ ë¡í‚· ëŸ°ì³", A: 6, hit: "4+", dmg: "4/5", range: "Ranged", rules: ["Blast 1\"", "Heavy (Dash only)"] },
                        { name: "ë¡í‚· ëŸ°ì³", A: 6, hit: "5+", dmg: "4/5", range: "Ranged", rules: ["Blast 1\""] },
                        { name: "ì£¼ë¨¹", A: 3, hit: "3+", dmg: "3/4", range: "Melee", rules: [] }
                    ]
                },
                {
                    id: "rokkiteer",
                    name: "ë¡í‚¤í‹°ì–´",
                    role: "ì „ë¬¸ê°€",
                    stats: { M: "6\"", APL: 2, D: 3, S: "4+", W: 12 },
                    abilities: [
                        { title: "Pulsa", desc: "ë§ˆì»¤ ì„¤ì¹˜ (ì£¼ë³€ ì  D3 í”¼í•´)." },
                        { title: "Shokkwave", desc: "ë§ˆì»¤ ê·¼ì²˜ ì  -1 Hit, -2\" Move." }
                    ],
                    weapons: [
                        { name: "ë¡í‚· ëŸ°ì³", A: 6, hit: "5+", dmg: "4/5", range: "Ranged", rules: ["Blast 1\""] },
                        { name: "ë¡í‚· ë™", A: 6, hit: "5+", dmg: "4/5", range: "Ranged", rules: ["Blast 2\"", "Relentless", "Limited 1", "Heavy"] },
                        { name: "í„ì‚¬ ë¡í‚·", A: 6, hit: "5+", dmg: "-/-", range: "Ranged", rules: ["Pulsa", "Limited 1", "Heavy"] },
                        { name: "ì£¼ë¨¹", A: 3, hit: "3+", dmg: "3/4", range: "Melee", rules: [] }
                    ]
                }
            ]
        }
    };

    /** ìƒíƒœ ê´€ë¦¬ */
    const STORAGE_KEY = 'kt_roster_library'; 
    let savedRosters = []; 
    let currentRosterId = null; 

    let currentTeamId = "ork_wrecka_krew";
    let myRoster = [];
    
    let gameState = { vp: 0, cp: 2, fp: 0, currentTP: 1, operatives: [] };
    let currentOpForEquip = null; 

    document.addEventListener('DOMContentLoaded', function() {
        init();
    });

    function init() {
        if (!document.getElementById('team-select')) return;
        populateTeamSelect();
        loadLibrary();
        const nameInput = document.getElementById('roster-name');
        if (nameInput) nameInput.addEventListener('input', autoSave);
        if (savedRosters.length > 0) loadRosterById(savedRosters[0].id);
        else resetToNewRoster();
    }

    /* ìœ í‹¸ë¦¬í‹° */
    function showToast(msg) {
        const el = document.getElementById('toast-msg');
        if (!el) return;
        el.innerText = msg; el.classList.add('show');
        setTimeout(() => { el.classList.remove('show'); }, 2000);
    }

    function switchTab(tabId, e) {
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(con => con.classList.remove('active'));
        if(e && e.target) e.target.classList.add('active');
        const tab = document.getElementById(`tab-${tabId}`);
        if(tab) tab.classList.add('active');
    }

    /* 1. ë¡œìŠ¤í„° ë° ë°ì´í„° ê´€ë¦¬ */
    function populateTeamSelect() {
        const select = document.getElementById('team-select');
        if(!select) return;
        select.innerHTML = '';
        for (const [key, val] of Object.entries(catalog)) {
            const option = document.createElement('option');
            option.value = key; option.text = val.name; select.appendChild(option);
        }
    }
    
    function changeTeam(shouldSave = true) {
        const select = document.getElementById('team-select');
        if(!select) return;
        currentTeamId = select.value;
        updateTeamUI();
        myRoster = [];
        renderRosterList();
        if (shouldSave) autoSave();
    }

    function updateTeamUI() {
        const teamData = catalog[currentTeamId];
        if(!teamData) return;
        document.documentElement.style.setProperty('--primary-color', teamData.color);
        const rulesEl = document.getElementById('team-rules-text');
        if(rulesEl) rulesEl.innerHTML = teamData.rulesText;
    }

    /* ì¥ë¹„ ê´€ë¦¬ ë¡œì§ (ê°œë³„ ì˜¤í¼) */
    function openEquipModal(opIdx) {
        currentOpForEquip = opIdx;
        const list = document.getElementById('equip-modal-list');
        const teamData = catalog[currentTeamId];
        list.innerHTML = '';

        if (!teamData.equipments || teamData.equipments.length === 0) {
            list.innerHTML = '<p>ì¥ë¹„ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        } else {
            let totalEquipCount = 0;
            const takenEquipIds = [];
            // íŒ€ ì „ì²´ì—ì„œ ê° ì¥ë¹„ë³„ë¡œ ëª‡ ê°œ ì„ íƒë˜ì—ˆëŠ”ì§€ ì¹´ìš´íŠ¸
            const equipUsageCounts = {};

            myRoster.forEach(op => {
                if(op.assignedEquipments) {
                    totalEquipCount += op.assignedEquipments.length;
                    op.assignedEquipments.forEach(e => {
                        takenEquipIds.push(e.id);
                        equipUsageCounts[e.id] = (equipUsageCounts[e.id] || 0) + 1;
                    });
                }
            });

            const isTeamFull = totalEquipCount >= 4;

            teamData.equipments.forEach(eq => {
                // limit ì„¤ì • í™•ì¸ (ê¸°ë³¸ê°’ ë¬´ì œí•œ, ë ‰ì¹´ëŠ” 1)
                const limit = eq.limit !== undefined ? eq.limit : 99;
                const currentCount = equipUsageCounts[eq.id] || 0;
                
                const isLimitReached = currentCount >= limit;
                const isDisabled = isTeamFull || isLimitReached;
                
                let reason = "";
                if (isLimitReached) reason = `(ì œí•œ ë„ë‹¬: ${limit}/${limit})`;
                else if (isTeamFull) reason = "(ì¥ë¹„ í•œë„ 4ê°œ ì´ˆê³¼)";

                const btn = document.createElement('button');
                btn.innerHTML = `<span style="font-weight:bold; color:#e67e22;">${eq.name}</span> <span style="font-size:0.8rem;">${reason}</span><br><span style="font-size:0.8rem; color:#aaa;">${eq.desc}</span>`;
                btn.disabled = isDisabled;
                btn.onclick = () => { addEquipToOp(eq); };
                list.appendChild(btn);
            });
        }
        document.getElementById('equip-modal-overlay').style.display = 'flex';
    }

    function closeEquipModal() { document.getElementById('equip-modal-overlay').style.display = 'none'; }

    function addEquipToOp(equipData) {
        if (currentOpForEquip === null) return;
        const op = myRoster[currentOpForEquip];
        if (!op.assignedEquipments) op.assignedEquipments = [];
        
        // ì¥ë¹„ ì¶”ê°€ ì‹œ isUsed ì†ì„± ì´ˆê¸°í™”
        const newEquip = JSON.parse(JSON.stringify(equipData));
        newEquip.isUsed = false;
        
        op.assignedEquipments.push(newEquip);
        closeEquipModal();
        renderRosterList();
        autoSave();
    }

    function removeEquipFromOp(opIdx, eqIdx) {
        myRoster[opIdx].assignedEquipments.splice(eqIdx, 1);
        renderRosterList();
        autoSave();
    }

    function getTeamEquipCount() {
        let cnt = 0;
        myRoster.forEach(op => { if(op.assignedEquipments) cnt += op.assignedEquipments.length; });
        return cnt;
    }

    // ì¥ë¹„ ì‚¬ìš© ìƒíƒœ í† ê¸€ (ê²Œì„ ëª¨ë“œ)
    function toggleEquipUsed(opIdx, eqIdx) {
        const op = gameState.operatives[opIdx];
        if (op && op.assignedEquipments && op.assignedEquipments[eqIdx]) {
            const eq = op.assignedEquipments[eqIdx];
            eq.isUsed = !eq.isUsed; // í† ê¸€
            renderGameScreen();
        }
    }

    /* ì €ì¥/ë¡œë“œ ë¡œì§ */
    function switchRoster() {
        const select = document.getElementById('roster-select');
        if(!select) return;
        const val = select.value;
        val === 'new' ? resetToNewRoster() : loadRosterById(val);
    }

    function updateRosterSelectDropdown() {
        const select = document.getElementById('roster-select');
        if(!select) return;
        select.innerHTML = '';
        const newOption = document.createElement('option'); newOption.value = 'new'; newOption.text = '+ ìƒˆ ë¡œìŠ¤í„° ë§Œë“¤ê¸°'; select.appendChild(newOption);
        savedRosters.forEach(r => {
            const opt = document.createElement('option');
            opt.value = r.id; opt.text = r.name || "(ì´ë¦„ ì—†ìŒ)"; select.appendChild(opt);
        });
        select.value = currentRosterId || 'new';
    }

    function resetToNewRoster() {
        currentRosterId = null;
        const nameEl = document.getElementById('roster-name');
        if(nameEl) nameEl.value = "ìƒˆ ë¡œìŠ¤í„°";
        myRoster = [];
        const defaultTeam = Object.keys(catalog)[0];
        const teamSelect = document.getElementById('team-select');
        if(teamSelect) teamSelect.value = defaultTeam;
        currentTeamId = defaultTeam;
        updateTeamUI(); renderRosterList(); updateRosterSelectDropdown();
    }

    function loadRosterById(id) {
        const found = savedRosters.find(r => r.id === id);
        if (!found) return;
        currentRosterId = found.id;
        const nameEl = document.getElementById('roster-name');
        if(nameEl) nameEl.value = found.name;
        myRoster = JSON.parse(JSON.stringify(found.roster));
        if (catalog[found.teamId]) {
            currentTeamId = found.teamId;
            const teamSelect = document.getElementById('team-select');
            if(teamSelect) teamSelect.value = currentTeamId;
            updateTeamUI();
        }
        renderRosterList(); updateRosterSelectDropdown();
    }

    function autoSave() {
        const nameEl = document.getElementById('roster-name');
        const name = nameEl ? nameEl.value : "Unknown";
        const rosterData = { 
            id: currentRosterId, name: name, teamId: currentTeamId, 
            roster: myRoster, 
            updatedAt: new Date().getTime() 
        };
        if (!currentRosterId) {
            rosterData.id = 'roster_' + new Date().getTime();
            currentRosterId = rosterData.id; savedRosters.push(rosterData);
        } else {
            const idx = savedRosters.findIndex(r => r.id === currentRosterId);
            if (idx >= 0) savedRosters[idx] = rosterData; else savedRosters.push(rosterData);
        }
        localStorage.setItem(STORAGE_KEY, JSON.stringify(savedRosters));
        updateRosterSelectDropdown();
        showToast("ìë™ ì €ì¥ë¨");
    }

    function deleteCurrentRoster() {
        if (!currentRosterId) { showToast("ì €ì¥ë˜ì§€ ì•Šì€ ë¡œìŠ¤í„°ì…ë‹ˆë‹¤."); return; }
        savedRosters = savedRosters.filter(r => r.id !== currentRosterId);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(savedRosters));
        resetToNewRoster(); showToast("ì‚­ì œë¨");
    }
    
    function loadLibrary() {
        const json = localStorage.getItem(STORAGE_KEY);
        if (json) try { savedRosters = JSON.parse(json); } catch (e) { savedRosters = []; }
    }

    /* ë Œë”ë§ */
    function renderRosterList() {
        const container = document.getElementById('my-roster-list');
        const countSpan = document.getElementById('roster-count');
        const equipSpan = document.getElementById('equip-count');
        
        if(!container) return;
        container.innerHTML = ''; 
        if(countSpan) countSpan.innerText = myRoster.length;
        if(equipSpan) equipSpan.innerText = getTeamEquipCount();
        
        if (myRoster.length === 0) { 
            container.innerHTML = '<div style="text-align:center; padding:20px; color:#aaa; border: 2px dashed #555; border-radius:4px;">íŒ€ì›ì´ ì—†ìŠµë‹ˆë‹¤.<br>ì¶”ê°€ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>'; 
            return; 
        }
        myRoster.forEach((op, index) => { container.innerHTML += renderOpCard(op, 'roster', index); });
    }

    function renderOpCard(op, mode, idx) {
        const isGameMode = (mode === 'game');
        const isRosterMode = (mode === 'roster');
        
        const isDead = isGameMode && (op.currentW <= 0);
        const isInjured = isGameMode && !isDead && (op.currentW < op.stats.W / 2);

        let cardClass = 'op-card';
        let badgeHtml = '';
        if (isDead) { cardClass += ' incapacitated'; badgeHtml = '<div class="status-badge badge-dead">ğŸ’€ ì‚¬ë§</div>'; }
        else if (isInjured) { cardClass += ' injured'; badgeHtml = '<div class="status-badge badge-injured">ğŸ©¹ ë¶€ìƒ (-2"M / -1BS)</div>'; }

        let displayM = op.stats.M;
        let injuredClass = isInjured ? 'stat-modified' : '';
        if (isInjured) {
            const moveVal = parseInt(op.stats.M.replace('"', ''));
            displayM = Math.max(0, moveVal - 2) + '"';
        }

        let abilitiesHtml = '';
        if (op.abilities && op.abilities.length > 0) {
            const list = op.abilities.map(a => `<div class="ability-item"><span class="ability-title">${a.title}:</span><span class="ability-desc">${a.desc}</span></div>`).join('');
            abilitiesHtml = `<div class="op-abilities">${list}</div>`;
        }

        const weaponsHtml = op.weapons.map((w, wIdx) => {
            if (isGameMode && w.active === false) return '';
            const isActive = (w.active !== false);
            let rowClass = 'weapon-row';
            let onclickAttr = '';
            if (isRosterMode) {
                rowClass += ' interactive';
                if (!isActive) rowClass += ' inactive';
                onclickAttr = `onclick="toggleWeapon(${idx}, ${wIdx})"`;
            }
            let hitVal = w.hit;
            if (isInjured) {
                const baseHit = parseInt(w.hit.replace('+', ''));
                hitVal = (baseHit + 1) + '+';
            }
            const rangeBadgeClass = w.range === 'Ranged' ? 'range-ranged' : 'range-melee';
            const rangeBadgeText = w.range === 'Ranged' ? 'R' : 'M';
            let rulesHtml = '';
            if (w.rules && w.rules.length > 0) {
                const ruleTags = w.rules.map(r => `<span class="rule-tag">${r}</span>`).join(', ');
                rulesHtml = `<div class="weapon-rules">${ruleTags}</div>`;
            }
            return `
                <div class="${rowClass}" ${onclickAttr}>
                    <div class="weapon-main">
                        <div style="display:flex; align-items:center;">
                            <span class="weapon-range-badge ${rangeBadgeClass}">${rangeBadgeText}</span>
                            <span class="weapon-name">${w.name}</span>
                        </div>
                        <span class="weapon-stats">
                            A:${w.A}&nbsp; Hit:<span class="${injuredClass}">${hitVal}</span>&nbsp; D:${w.dmg}
                        </span>
                    </div>
                    ${rulesHtml}
                </div>`;
        }).join('');

        const tipHtml = isRosterMode ? `<div class="weapon-tip">ğŸ’¡ ë¬´ê¸°ë¥¼ í´ë¦­í•˜ì—¬ í™œì„±/ë¹„í™œì„±(ì‚¬ìš© ì•ˆí•¨) ìƒíƒœë¥¼ ë³€ê²½í•˜ì„¸ìš”.</div>` : '';

        // --- ì²´ë ¥ íŠ¸ë˜ì»¤ ---
        let woundsArea = '';
        if (isGameMode) {
            const maxW = op.stats.W;
            const curW = op.currentW;
            const startW = op.startOfTurnW; 
            let btnsHtml = '';
            for(let i = 1; i <= maxW; i++) {
                let stateClass = '';
                if (i <= curW) { if (i <= startW) stateClass = 'active'; else stateClass = 'recovered'; } 
                else { if (i <= startW) stateClass = 'damaged'; else stateClass = 'inactive'; }
                btnsHtml += `<div class="hp-btn ${stateClass}" onclick="setWounds(${idx}, ${i})">${i}</div>`;
            }
            woundsArea = `<div class="wounds-container"><div class="wounds-label"><span>ì²´ë ¥</span><span style="color:white; font-weight:bold;">${curW} / ${maxW}</span></div><div class="hp-grid">${btnsHtml}</div></div>`;
        }

        // --- ì¥ë¹„ ì„¹ì…˜ ---
        let equipSection = '';
        if (op.assignedEquipments && op.assignedEquipments.length > 0) {
            const items = op.assignedEquipments.map((e, eIdx) => {
                const isUsed = e.isUsed || false;
                const usedClass = isUsed ? 'used' : '';
                const clickAttr = isGameMode ? `onclick="toggleEquipUsed(${idx}, ${eIdx})"` : '';
                const cursorClass = isGameMode ? 'interactive' : '';
                
                const rmBtn = isRosterMode ? `<button style="background:transparent; border:none; color:red; cursor:pointer;" onclick="removeEquipFromOp(${idx}, ${eIdx})">âœ–</button>` : '';
                
                return `<div class="card-equip-item ${usedClass} ${cursorClass}" ${clickAttr}>
                            <div>
                                <span class="equip-name">${e.name}</span>
                                <div class="equip-desc-small">${e.desc}</div>
                            </div>
                            ${rmBtn}
                        </div>`;
            }).join('');
            equipSection = `<div class="card-equip-section">${items}</div>`;
        }

        let actionArea = '';
        if (mode === 'modal') actionArea = `<button class="btn btn-primary btn-small" onclick="addOpFromModal(${idx})">â• íŒ€ì— ì¶”ê°€</button>`;
        else if (mode === 'roster') {
            actionArea = `
                <div style="display:flex; justify-content:space-between; margin-top:10px;">
                    <button class="btn-equip" onclick="openEquipModal(${idx})">â• ì¥ë¹„ ì¶”ê°€</button>
                    <button class="btn btn-danger btn-small" onclick="removeOp(${idx})">ğŸ—‘ï¸ ì œê±°</button>
                </div>
            `;
        }
        
        return `
            <div class="${cardClass}">
                ${badgeHtml}
                <div class="op-header">
                    <h3>${op.name}</h3>
                    <span class="op-role">${op.role}</span>
                </div>
                <table class="stat-table">
                    <thead><tr><th>M</th><th>APL</th><th>DF</th><th>SV</th><th>W</th></tr></thead>
                    <tbody><tr><td class="${injuredClass}">${displayM}</td><td>${op.stats.APL}</td><td>${op.stats.D}</td><td>${op.stats.S}</td><td>${op.stats.W}</td></tr></tbody>
                </table>
                ${abilitiesHtml}
                <div style="margin: 5px 0;">${weaponsHtml}${tipHtml}</div>
                ${equipSection}
                ${woundsArea}
                ${actionArea}
            </div>
        `;
    }

    function toggleWeapon(opIdx, wIdx) {
        const weapon = myRoster[opIdx].weapons[wIdx];
        if (weapon.active === undefined) weapon.active = true;
        weapon.active = !weapon.active;
        renderRosterList(); autoSave();
    }

    /* ëª¨ë‹¬ */
    function openAddModal() {
        const list = document.getElementById('modal-op-list'); list.innerHTML = '';
        const currentTeamOps = catalog[currentTeamId].operatives;
        currentTeamOps.forEach((op, index) => { list.innerHTML += renderOpCard(op, 'modal', index); });
        document.getElementById('modal-overlay').style.display = 'flex';
    }
    function closeAddModal() { document.getElementById('modal-overlay').style.display = 'none'; }
    function addOpFromModal(index) { 
        const currentTeamOps = catalog[currentTeamId].operatives;
        addOp(currentTeamOps[index]); closeAddModal(); 
    }
    function addOp(opData) { 
        const newOp = JSON.parse(JSON.stringify(opData));
        newOp.weapons.forEach(w => w.active = true);
        newOp.assignedEquipments = []; // ì¥ë¹„ ë°°ì—´ ì´ˆê¸°í™”
        myRoster.push(newOp); renderRosterList(); autoSave(); 
    }
    function removeOp(index) { myRoster.splice(index, 1); renderRosterList(); autoSave(); }

    /* ì •ë³´ ë³´ê¸° ëª¨ë‹¬ */
    function openInfoModal() {
        const team = catalog[currentTeamId];
        
        document.getElementById('info-faction-rules').innerHTML = team.factionRules.map(r => 
            `<div class="ploy-card"><div class="ploy-name" style="color:var(--primary-color)">${r.title}</div><div class="ploy-desc">${r.desc}</div></div>`
        ).join('');
        
        document.getElementById('info-strat-ploys').innerHTML = team.ploys.strategy.map(p => 
            `<div class="ploy-card strat"><div class="ploy-header"><span class="ploy-name">${p.name}</span><span class="ploy-cost">${p.cost}</span></div><div class="ploy-desc">${p.desc}</div></div>`
        ).join('');

        document.getElementById('info-fire-ploys').innerHTML = team.ploys.firefight.map(p => 
            `<div class="ploy-card fire"><div class="ploy-header"><span class="ploy-name">${p.name}</span><span class="ploy-cost">${p.cost}</span></div><div class="ploy-desc">${p.desc}</div></div>`
        ).join('');

        document.getElementById('info-modal-overlay').style.display = 'flex';
    }
    function closeInfoModal() { document.getElementById('info-modal-overlay').style.display = 'none'; }

    /* 3. ê²Œì„ ë¡œì§ */
    function startGame() {
        if(myRoster.length === 0) { showToast("íŒ€ì›ì„ ìµœì†Œ 1ëª… ì´ìƒ ì¶”ê°€í•´ì£¼ì„¸ìš”!"); return; }
        const teamData = catalog[currentTeamId];

        gameState.vp = 0; 
        gameState.cp = 2;
        gameState.fp = teamData.resourceConfig ? teamData.resourceConfig.start : 0;
        gameState.currentTP = 1;
        
        gameState.operatives = JSON.parse(JSON.stringify(myRoster));
        gameState.operatives.forEach(op => { op.currentW = op.stats.W; op.startOfTurnW = op.stats.W; });

        const titleEl = document.getElementById('game-title');
        const nameEl = document.getElementById('roster-name');
        if(titleEl && nameEl) titleEl.innerText = nameEl.value;
        
        renderGameInfo(); // ê·œì¹™/ê³„ëµ íƒ­
        renderGameEquipment(); // ì¥ë¹„ ë„ê° íƒ­
        updateResourceDisplay(); 
        renderGameScreen(); 
        showScreen('game');
        
        const firstTabBtn = document.querySelector('.tab-btn');
        if(firstTabBtn) switchTab('ops', { target: firstTabBtn });
    }

    function renderGameEquipment() {
        const container = document.getElementById('game-equipment-list');
        const teamData = catalog[currentTeamId];
        if(!container) return;
        
        container.innerHTML = teamData.equipments.map(e => `
            <div class="ploy-card">
                <div class="ploy-header"><span class="ploy-name">${e.name}</span><span class="ploy-cost">${e.cost}</span></div>
                <div class="ploy-desc">${e.desc}</div>
            </div>
        `).join('');
    }

    function renderGameInfo() {
        const team = catalog[currentTeamId];
        
        const fpBox = document.getElementById('faction-res-box');
        if(fpBox) {
            if (team.resourceConfig) {
                fpBox.style.display = 'flex';
                const nameEl = document.getElementById('fp-name');
                if(nameEl) nameEl.innerText = team.resourceConfig.name;
            } else {
                fpBox.style.display = 'none';
            }
        }

        const rList = document.getElementById('game-faction-rules');
        if(rList) rList.innerHTML = team.factionRules.map(r => 
            `<div class="ploy-card"><div class="ploy-name" style="color:var(--primary-color)">${r.title}</div><div class="ploy-desc">${r.desc}</div></div>`
        ).join('');
        
        const sList = document.getElementById('game-strat-ploys');
        if(sList) sList.innerHTML = team.ploys.strategy.map(p => 
            `<div class="ploy-card strat"><div class="ploy-header"><span class="ploy-name">${p.name}</span><span class="ploy-cost">${p.cost}</span></div><div class="ploy-desc">${p.desc}</div><button class="btn-outline" style="margin-top:5px; width:100%; font-size:0.8rem;" onclick="spendCP()">ì‚¬ìš© (CP ì†Œëª¨)</button></div>`
        ).join('');

        const fList = document.getElementById('game-fire-ploys');
        if(fList) fList.innerHTML = team.ploys.firefight.map(p => 
            `<div class="ploy-card fire"><div class="ploy-header"><span class="ploy-name">${p.name}</span><span class="ploy-cost">${p.cost}</span></div><div class="ploy-desc">${p.desc}</div><button class="btn-outline" style="margin-top:5px; width:100%; font-size:0.8rem;" onclick="spendCP()">ì‚¬ìš© (CP ì†Œëª¨)</button></div>`
        ).join('');
    }

    function spendCP() {
        if (gameState.cp > 0) { updateResource('cp', -1); showToast("CPë¥¼ ì†Œëª¨í–ˆìŠµë‹ˆë‹¤."); } 
        else { showToast("CPê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!"); }
    }
    
    function showScreen(name) { 
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); 
        const target = document.getElementById(`screen-${name}`);
        if(target) target.classList.add('active'); 
    }
    
    function updateResource(type, val) { 
        gameState[type] += val; 
        if(gameState[type] < 0) gameState[type] = 0;
        if(type === 'fp') {
            const conf = catalog[currentTeamId].resourceConfig;
            if(conf && gameState.fp > conf.max) gameState.fp = conf.max;
        }
        updateResourceDisplay(); 
    }
    
    function updateTP(val) {
        gameState.currentTP += val; if(gameState.currentTP < 1) gameState.currentTP = 1;
        finalizeWoundStates(); updateResourceDisplay(); renderGameScreen();
    }

    function endTurn() {
        gameState.cp += 1; gameState.currentTP += 1;
        finalizeWoundStates(); updateResourceDisplay(); renderGameScreen();
        showToast("í„´ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. (CP+1, TP+1)");
    }

    function finalizeWoundStates() { gameState.operatives.forEach(op => { op.startOfTurnW = op.currentW; }); }

    function updateResourceDisplay() { 
        const vpEl = document.getElementById('vp-val');
        const cpEl = document.getElementById('cp-val');
        const fpEl = document.getElementById('fp-val');
        const tpEl = document.getElementById('tp-val');
        
        if(vpEl) vpEl.innerText = gameState.vp; 
        if(cpEl) cpEl.innerText = gameState.cp; 
        if(fpEl) fpEl.innerText = gameState.fp;
        if(tpEl) tpEl.innerText = gameState.currentTP;
    }
    
    function setWounds(opIdx, val) {
        const op = gameState.operatives[opIdx];
        if (op.currentW === val) { op.currentW = val - 1; } else { op.currentW = val; }
        renderGameScreen();
    }
    
    function renderGameScreen() {
        const container = document.getElementById('game-op-list'); 
        if(!container) return;
        container.innerHTML = '';
        gameState.operatives.forEach((op, idx) => { container.innerHTML += renderOpCard(op, 'game', idx); });
    }

</script>
</body>
</html>